The accurate and efficient simulation of interface evolution is of fundamental importance in the simulation of multiphase flows. It is essential that the interface remains sharp. Large jumps of fluid density and viscosity across the interface should be correctly assumed by the numerical algorithm in order to satisfy the momentum balance at the vicinity of the interface.

Methods used to describe the evolution of interfaces can be clustered in two classes, namely: interface capturing and interface tracking methods. While in the former the interface is determined by an implicit function that is advected in a Eulerian frame (see Volume of Fluid \cite{VoF} and Level Set\cite{Osher01}), in the latter the interface evolution equation is solved in a Lagrangian fashion, for example by evolving marker particles. The spatial domain discretization using mesh and particles allows PFEM2 to select an appropriate combination of those approaches where the free position information is shared and interchanged by the particles and the fixed mesh.

There are several, but no large, differences between the PFEM-2 algorithm for homogeneous flows and the multi-fluids version. Those differences are produced by the density and viscosity discontinuities that appear in the fluid, consequently most of the changes are related to the strategies followed to capture correctly the interface between both fluids. Although some details presented in this section have been reported in \cite{Idelsohn13c}, however in this work we consider add important strategies that easily improve the accuracy and efficiency of the computation.

Taking into account the Algorithm presented in section \ref{PFEM_Algorithm}, next are considerations to manage and improve each one of the stages for the particular case of multifluids problems. The following part is basically related with three aspects of the simulation: the kinematic treatment of the fluid particles during the X-IVAS stage, the enrichment technique for the free surface definition and the pressure computation step. Although these three topics are listed independently, the are closely related to each other during the computation and consequently the will be treated together in the next section.

\subsection{Internal interfaces tracking}

When two different fluids separated by an interface are considered, each particle $p$ carries the information of the fluid that was initially assigned, this quantity is represented by a scalar function $\lambda_p$ has integer values -1 or 1 depending if it belongs to the first or second fluid. This value is advected adding one equation to the \textit{Streamline Integration Stage}: $\frac{D\lambda}{Dt}=0$, i.e. each particle keeps its marker value during the entire simulation. This function is projected to the mesh nodes to determine the free surface position. Mesh nodes consequently obtain real values from the projection different to the integer values $\pm1$ that particles transport. Free surface interface is defined as the set of points that satisfy the equation $\lambda=0$.

In general, the movement of a particle is done by sub-steps according to the equation (\ref{Step2astep}). The velocity used in the particle movement at position $\mathbf{x}_p$ is calculated by the equation:

\begin{equation}\label{Interpolation}
    \displaystyle \mathbf{v}(\mathbf{x}_p)=\frac{\sum_{i(\rho_i=\rho_p)}\mathbf{v}_i^n\psi_i(\mathbf{x}_p)}{\sum_{i(\rho_i=\rho_p)}\psi_i}
\end{equation}

where the nodes included in the interpolation are the nodes of the hosting element that have the same density as the particle. Two situations could happen to every particle when it changes its position: all the nodes of the hosting element can have the same density as the fluid particle or one or more nodes can have different density as the fluid particle. In the first case, the denominator of the equation (\ref{Interpolation}) is equal to 1 and a typical finite element interpolation is performed, the second situation clearly represents a situation where the fluid particle is close to the interface. In fact the denominator of the equation (\ref{Interpolation}) measures how isolated is the particle compared to its hosting nodes in terms of density. Let us study this second possibility when there is high enough density ratio $\rho_1/\rho_2>20$, two situations can appear:

 \begin{itemize}
 \item $\rho_p=\rho_2$ (light particle in a heavy fluid). The velocity will be computed using equation (\ref{Interpolation}).
   \item $\rho_p=\rho_1$ (heavy particle in a light fluid). Depending on the value of $\sum_{i(\rho_i=\rho_p)}\psi_i$ we can have 2 possibilities:
       \begin{itemize}
 \item $\sum_{i(\rho_i=\rho_p)}\psi_i<0.05$ the gravity force will be included in the computation of the particle trajectory, which will be computed as a parabolic motion.
   \item $\sum_{i(\rho_i=\rho_p)}\psi_i>0.05$ equation (\ref{Interpolation}) is used to calculate the velocity.
 \end{itemize}
 \end{itemize}
 
 For those cases where the density ratio is not excessive, equation (\ref{Interpolation}) is always used.
 
 This means that if a water particle is momentarily on an air regime, it will remain as a water particle for further determination of the interface position. However, in that case and because the most similar path to the real trajectory of the particle is desired, the particle leaves the streamlines and follows a trajectory defined by the acting forces, being the simplest one the parabolic motion (only gravity force) or coupled with a water droplet drag model.

Once the particle have been advected and the intermediate velocities have been determined, mesh nodes have to incorporate this updated velocity and density information. During this \textit{Projection Stage}, each node $j$ updates its intermediate velocity according to equation (\ref{Step3a}) and also its value $\lambda_j$. Depending on the value of $\lambda_j$ the instantaneous local interface inside each element is determined as the iso-line (an iso-plane in 3D) where $\lambda(\xx)=0$.

\subsection{Shape function enrichments for pressure gradient discontinuity capturing}

In typical finite element methods, the gradient of the shape functions $\nabla\phi_j$ are continuous within each element, and therefore any unknown interpolated is also continuous. When the interface crosses an element the discontinuity in the material properties leads to discontinuities in the gradients of the unknowns that the interpolation used cannot capture. For the case of two different density fluids the interpolation errors in the pressure give rise to spurious velocities that can render the solution meaningless.

Enrichment methods add degrees of freedom at elements cut by the interface in order to reduce interpolation errors. In this work, the enriched space mainly used is based on the one presented by Coppola\cite{Coppola05}, which is illustrated in Figure \ref{fg:enrichment1}. The new degree of freedom could be statically condensed within each element in the pressure equation and then recovered in the correction step. Briefly, the way to construct the enrichment function $\phi^*$ is ensuring that

\begin{equation}
   \left\{\;
   \begin{matrix}
      \phi^*(\xx_A)= 1 \\
      \phi^*(\xx_1)= \phi^*(\xx_2)=\phi^*(\xx_3)= 0
   \end{matrix}\;
   \right.
   \label{eq:enrich-1a}
\end{equation}

It can be demonstrated\cite{Coppola05} that the enrichment function, which accomplishes the above presented restrictions, can be expressed as a linear combination of the traditional shape functions, being:
 \begin{align}
    \phi^*|_{\Omega_2} = & \ k_1 \phi_1 \label{phi_enrichment-2}\\
    \phi^*|_{\Omega_1} = & \ k_2 \phi_2 + k_3 \phi_3 \label{phi_enrichment-1}
  \end{align}
where $k_1 = \dfrac{\lambda_2-\lambda_1}{\lambda_2}$, $k_2 = \dfrac{\lambda_1-\lambda_2}{\lambda_1}$, $k_3 = -k_1\dfrac{\lambda_3\lambda_1}{\lambda_3-\lambda_1}$, whilst $\Omega_1$ and $\Omega_2$ are the two regions of the split element.

\begin{figure}[H]
  \centering
  \includegraphics[width=.9\columnwidth]{images/enrichment1.pdf}
   \caption{2D interface element. The interface is calculated cutting the element with the segment $A-B$. The enrichment proposed by Coppola and the partition of the triangle into three sub-triangles with its own Gauss points to allowing to calculate an enhanced integration is shown.}
   \label{fg:enrichment1}                %% Etiqueta para la figura entera
\end{figure}

The other set of enrichment functions used in this work is presented in Figure \ref{fg:enrichment2}. As in the previous case, the two new degrees of freedom can also be statically condensed. However, using this space it is possible to ensure continuity between elements, but paying the cost of having to rebuild the system matrix at each time step, which could be an expensive task due to memory allocation.
This enrichment space is constructed following

\begin{equation}
   \left\{\;
   \begin{matrix}
     \phi_A^*(\xx_A)=\phi_B^*(\xx_B)=1 \\
     \phi_A^*(\xx_1)=\phi_A^*(\xx_2)=\phi_A^*(\xx_3)=\phi_A^*(\xx_B)=0 \\
     \phi_B^*(\xx_1)=\phi_B^*(\xx_2)=\phi_B^*(\xx_3)=\phi_B^*(\xx_A)=0
   \end{matrix}\;
   \right.
   \label{eq:enrich-2a}
\end{equation}



\begin{figure}[H]
  \centering
   \includegraphics[width=.9\columnwidth]{images/enrichment2.pdf}
   \caption{2D interface element. The interface is calculated cutting the element with the segment $A-B$. An enrichment space with two functions per interface element, which can be used to ensure continuity between elements, is presented. The integration partition is the same as presented above (Figure \ref{fg:enrichment1}).}
   \label{fg:enrichment2}
\end{figure}

% \begin{figure}[H]
%   \centering
%     \subfloat[]{
% 	  \label{fg:enrichment1}         %% Etiqueta para la primera subfigura
% 	  \includegraphics[width=.9\columnwidth]{images/enrichment1.pdf}
%     } \\
%     %%----segunda subfigura----
%     \subfloat[]{
% 	  \label{fg:enrichment2}         %% Etiqueta para la segunda subfigura
% 	  \includegraphics[width=.9\columnwidth]{images/enrichment2.pdf}
%     }
%    \caption{2D interface element. The interface is calculated cutting the element with the segment $A-B$. Figure \ref{fg:enrichment1} shows the enrichment proposed by Coppola and the partition of the triangle into three sub-triangles with its own Gauss points to allowing to calculate an enhanced integration. Figure \ref{fg:enrichment2} presents an enrichment space with two functions per interface element, which can be used to ensure continuity between elements. The integration partition is the same as presented above.}
%    \label{fg:enrichment}                %% Etiqueta para la figura entera
% \end{figure}

   Therefore, the pressure is now interpolated in the cut element following:

   \begin{equation}
      p_h(\xx) = \sum_{i=1}^{nnodes} \phi_i(\xx) \ p_i + \sum_{i=1}^{nenrich} \phi_i^*(\xx) \ p_i^*
   \end{equation}
   where $\phi_i$ are the $nnodes$ traditional linear shape functions, and $\phi_i^*$ are the $nenrich$ enrichment shape functions.

   In order to capture the discontinuities and take advantage of the enrichment functions used, the integration rules need to be modified in elements cut by the front. The method we use is to divide each  tetrahedral (triangular in 2D) element into up to six tetrahedral
  (three triangular in 2D) sub elements. For each sub element the same integration rule as for the non-cut elements is used. Figure \ref{fg:enrichment1} shows that partition and the small circles represent the Gauss points for the integration. When using enrichment functions for the pressure, the material properties $\rho$,$\mu$ are taken as $\rho_1$,$\mu_1$ or $\rho_2$,$\mu_2$, depending on which part of the domain ($\Omega_1$ or $\Omega_2$) the integration point is found.

   \subsection{Pressure Calculation}

Particles can move across several elements and through the interface during a time step and the pressure gradient of the previous time step would introduce a poor and even unstable approximation of the pressure forces. In order to avoid these large errors in the evaluation of the pressure gradients in the initial value of the iterative process, the value of the pressure is set to zero at the beginning of each time-state. Therefore, the acceleration over the particle calculated in X-IVAS stage is only is due to gravity force (pressure gradient is considered null and viscous forces are treated implicitly)\cite{Idelsohn13c}.

Starting from Equation \ref{Step5a}, and following the classical variational formulation, this is integrating, weighting with local shape functions and weakening, it is possible to obtain the elemental contribution:

\begin{equation}
   [\Delta t \int_{\Omega^e} \frac{1}{\rho} \nabla \phi^T \nabla \phi \ d\Omega] \delta p^{n+1} = [\int_{\Omega^e} \nabla \phi^T \psi \ d\Omega] \hat \vv_j^{n+1}
\end{equation}

in the case of split elements the enrichment shape functions are used, then the resulting system is:

  \begin{equation*}
   \begin{pmatrix}
      L_{std} & L_{std}^*\\
      {L_{std}^*}^T & L^*
   \end{pmatrix}\;
    \begin{pmatrix}
      \delta p^{n+1}\\
      p^*
   \end{pmatrix}\; = \;
   \begin{pmatrix}
      D_{std}\\
      D^*
   \end{pmatrix}\;
   (\hat{\vv}^{n+1})
   \label{poisson}
\end{equation*}

where
\begin{itemize}
 \item ${(L_{std})}_{ij} = \Delta t \int_{\Omega^e} \dfrac{1}{\rho} \nabla N_i^T \nabla N_j \ d\Omega$ with $[i,j] = 1,2,3$ (size [$3$x$3$])
 \item ${(L_{std}^*)}_{i} = \Delta t \int_{\Omega^e} \dfrac{1}{\rho} \nabla N_i^T \nabla N^* \ d\Omega$ with $i = 1,2,3$ (size [$3$x$1$])
 \item $L^* = \Delta t \int_{\Omega^e} \dfrac{1}{\rho} \nabla {N^*}^T \nabla N^* \ d\Omega$ (size [$1$x$1$])
 \item ${(D_{std})}_{ij} = \int_{\Omega^e} \nabla N_i^T \phi_j \ d\Omega$ with $[i,j] = 1,2,3$ (size [$3$x$3$])
 \item ${(D^*)}_{j} = \int_{\Omega^e}  \nabla {N^*}^ \phi_j \ d\Omega$ with $j = 1,2,3$ (size [$1$x$3$])
\end{itemize}

  Therefore, the system is statically condensed obtaining:

  \begin{equation}
   [L_{std} - L_{std}^*\frac{1}{L^*}{L_{std}^*}^T](\delta p^{n+1}) = [D_{std}- L_{std}^*\frac{1}{L^*}D^*](\hat{\vv}^{n+1})
   \label{condensing}
  \end{equation}

  If we are interested in solving the system in absolute pressure terms, the final system is

  \begin{equation}
  [L_{std} - L_{std}^*\frac{1}{L^*}{L_{std}^*}^T](p^{n+1}) = [D_{std}- L_{std}^*\frac{1}{L^*}D^*](\hat{\vv}^{n+1}) + [L_{std} - L_{std}^*\frac{1}{L^*}{L_{std}^*}^T] (p^n)
   \label{condensing-abs}
  \end{equation}


\subsection{Correction Stage}

 This stage is typical from fractional steps. However, the new degree of freedom for the pressure, which was condensed previously, must be taken into account in this step to calculate the correct pressure gradient. Therefore, we must \textit{recover} $p^*$ doing:

  \begin{equation}
  {p^*}^{n+1} = \frac{1}{L^*}[D^* \hat{\vv}^{n+1} - {L_{std}^*}^Tp^{n+1} + {L_{std}^*}^Tp^{n} + L^*{p^*}^n]
  \label{recovering}
  \end{equation}

 Finally, the equation system presented in Equation \ref{correction} must be solved.

 \begin{equation}
  \int_{\Omega} N \rho \vv^{n+1} d\Omega = \int_{\Omega} N \rho \hat{\vv}^{n+1} d\Omega - \Delta t \ [\int_{\Omega} N_{std} \nabla p^{n+1} d\Omega + \int_{\Omega} N^* \nabla p* d\Omega]
  \label{correction}
 \end{equation}

 Besides the nodal velocity correction, it also must be done the correction over particles. Must be noted this correction is done projecting the variation of the nodal velocity.
	
  \begin{equation}
    \rho_p \vv_p^{n+1}\  = \ \rho_p \hat \vv_p^{n+1} - \boldsymbol{\pi}^{-1}(\delta \vv_j^{n+1})
    \label{correction_particles}
  \end{equation}
  where $\delta \vv_j^{n+1} = \vv_j^{n+1} - \hat \hat \vv_j^{n+1}$.


\subsection{Iterations to improve the pressure-velocity coupling}

The initial value of the pressure iterations is set to zero in order to avoid large errors in the evaluation of the pressure gradients in the initial value of the iterative process. It must be noticed that despite this first iteration of the pressure calculation is
of first order, further iterations improve the incompressibility of the solution. Doing this implies that the stabilization effect of the first order fractional step is lost due to the higher order scheme. Tests with hundreds of iterations were performed and, effectively,
spurious pressure oscillations appear in the solution. However, for practical applications, only two or three iterations are needed in order to obtain pressure convergence and, despite not being theoretically stable, pressure oscillations do not appear in the solution. For this reason no stabilization technique is required in this case.

Another justification because the pressure is restarted each time step is that we can not predict accurately the value of ${p^*}^n$ on Equation \ref{recovering} at the first iteration (using the latest $p^*$ of the previous time-step may introduce several problems due to the movement of the interface). Therefore, the acceleration for the velocity in X-IVAS only can have the viscous forces.

%Detalle del tema de la inicializaciÃ³n a cero de la presiÃ³n, fundamentalmente por el hecho de que hay dos fluidos. Citar el clindro, como caso donde a pesar de haber un sÃ³lo fluido el algoritmo de puesta a cero de la presiÃ³n sigue siendo vÃ¡lido.
